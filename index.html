<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Masjid al Noor • Iqamah Times</title>
<style>
  :root{
    --bg:#0a0f0f; 
    --panel:#12181b; 
    --accent:#3b82f6;  /* BLUE accent */
    --muted:#97a3af; 
    --text:#e8f0f2;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;color:var(--text)}
  body{background: radial-gradient(1000px 600px at 70% -10%, rgba(59,130,246,.15) 0%, rgba(0,0,0,.65) 45%, rgba(0,0,0,.85) 100%);}
  .shell{position:relative; min-height:100%; padding:18px; display:flex; flex-direction:column; gap:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)); background-color:rgba(10,12,12,.65);
        border:1px solid rgba(255,255,255,.08); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
        backdrop-filter:blur(10px) saturate(120%);}

  /* Top digital clock */
  #clockNow {
    margin: 0 auto 10px auto;
    text-align: center;
    font-size: 42px;
    font-weight: 900;
    letter-spacing: 2px;
    width: 148px;           /* ~133% of 112px logo */
    max-width: 90%;
  }

  /* Header */
  .header.card{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    padding:14px 16px;
  }
  .header .center{
    grid-column:2;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  }
  .logo{
    height:112px; width:112px;
    object-fit:contain; border-radius:16px; background:#fff; /* fixed */
  }
  .titles{display:flex; flex-direction:column; gap:6px; text-align:center}
  .title{font-size:36px; font-weight:800; letter-spacing:.3px}
  .subtitle{font-size:14px; color:var(--muted)}

  /* Date chip */
  .datechip{
    grid-column:3; justify-self:end;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:18px 24px; border-radius:18px; background:var(--panel);
    border:1px solid rgba(255,255,255,.08); min-width:360px; text-align:center;
    font-weight:800; font-size:30px;
    line-height:1.2;
  }
  .datechip small{display:block; font-size:27px; color:var(--muted); font-weight:700; margin-top:2px}
  .datechip .hijri{display:block; font-size:24px; color:#bfdbfe; font-weight:800; margin-top:6px; letter-spacing:.2px}

  /* 3-column table */
  .table.card{padding:0; overflow:hidden; flex:1; min-height:0;}
  .thead{display:grid; grid-template-columns:2fr 1fr 1fr; gap:0; padding:14px 16px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.06)}
  .thead div{font-size:32px; color:var(--muted); font-weight:700; letter-spacing:.4px}
  .rows{display:flex; flex-direction:column; overflow:auto;}
  .row{display:grid; grid-template-columns:2fr 1fr 1fr; align-items:center; gap:0; padding:18px 16px; border-top:1px solid rgba(255,255,255,.06)}
  .row .name{font-size:28px; font-weight:800}
  .row .time{font-size:28px; font-weight:900; letter-spacing:.5px; display:flex; flex-direction:column;}
  .row .tomorrow{justify-self:end; font-weight:900; font-size:22px; color:#bfdbfe}
  .row.next{position:relative; background:linear-gradient(90deg, rgba(59,130,246,.08), rgba(255,255,255,0));}
  .row.next::after{content:''; position:absolute; inset:0; outline:3px solid var(--accent); border-radius:14px; opacity:.35; pointer-events:none}

  /* Inline countdown (only shows on the highlighted row) */
  .inlinecd{
    margin-top:6px;
    font-size:14px;
    font-weight:800;
    letter-spacing:.5px;
    color:#bfdbfe;
    opacity:.95;
  }

  /* WhatsApp promo card */
  .promo.card{padding:10px}
  .promo a{display:block; text-decoration:none; outline:0}
  .promo img{
    width:100%; height:auto; display:block; 
    border-radius:14px; 
    background:rgba(255,255,255,.06);
  }

  /* footer/status */
  #status{min-width:260px; text-align:right; color:var(--muted);}
</style>
</head>
<body>
  <div class="shell">

    <!-- Top digital clock -->
    <div id="clockNow">--:--</div>

    <div class="header card">
      <div></div> <!-- left spacer -->
      <div class="center">
        <img class="logo" src="./logo.png" alt="Logo" onerror="this.style.display='none'"/>
        <div class="titles">
          <div class="title">Masjid al Noor - Iqamah Times</div>
        </div>
      </div>
      <div class="datechip" id="datechip">
        <small>—</small>
        <span class="hijri" id="hijri">—</span>
      </div>
    </div>

    <div class="table card">
      <div class="thead">
        <div>Salah</div><div>Iqamah</div><div style="text-align:right">Tomorrow</div>
      </div>
      <div class="rows" id="rows"></div>
    </div>

    <!-- WhatsApp invite card -->
    <div class="promo card">
      <a href="https://www.whatsapp.com/channel/0029Vb6qOgq9MF8xjuiinL1f" target="_blank" rel="noopener" aria-label="Join our WhatsApp channel">
        <img src="./whatsapp.png" alt="Join our WhatsApp channel for the latest news and updates from Masjid al Noor" />
      </a>
    </div>

    <div id="status"></div>
  </div>

<script>
(() => {
  const TZ = 'Europe/London';
  const STORAGE_KEY  = 'kioskCSVTextV7';
  const STORAGE_NAME = 'kioskCSVNameV7';
  const AUTO_FILE    = './prayertime.csv';

  const PRS = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];

  const rowsEl = document.getElementById('rows');
  const datechip = document.getElementById('datechip');
  const statusEl = document.getElementById('status');
  const clockEl  = document.getElementById('clockNow');

  const norm = s => (s||'').toLowerCase().replace(/[\s_\-]/g,'').trim();
  const isDhuhr = s => ['dhuhr','dhur','zuhr','zuhur','duhr'].includes(norm(s));

  let cdTimer = null;
  let lastNextTime = null;
  let cache = null;

  function fmtTime(d){ return new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:TZ}).format(d); }
  function fmtDateLong(d){ return new Intl.DateTimeFormat('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric',timeZone:TZ}).format(d); }
  function fmtHijri(d){
    try{
      const f = new Intl.DateTimeFormat('en-GB-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric',timeZone:TZ});
      return f.format(d);
    }catch(e){ return ''; }
  }
  function tick(){
    const now=new Date();
    if(clockEl) clockEl.textContent = fmtTime(now);
    datechip.innerHTML = '<small>'+fmtDateLong(now)+'</small><span class="hijri">'+fmtHijri(now)+'</span>';
  }
  tick(); setInterval(tick,1000);

  // --- CSV parsing helpers (same as before) ---
  function cleanText(t){return t.replace(/^﻿/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');}
  function parseCSV(text){
    text = cleanText(text);
    const rows=text.split('\n').map(l=>l.split(','));
    const headers = rows[0];
    const data=rows.slice(1).map(r=>Object.fromEntries(headers.map((h,i)=>[h,r[i]||''])));
    return {headers,data};
  }
  function parseDate(s){return new Date(s);}
  function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
  function getRowForOffset(data,headers,offset){
    const base=new Date();
    const target=new Date(base.getFullYear(),base.getMonth(),base.getDate()+offset);
    for(const r of data){const d=parseDate(r[headers[0]]); if(sameDay(d,target)) return {row:r};}
    return null;
  }
  function displayHHMM(s){return s;}

  function render(todayRow,tomorrowRow,headers){
    cache={todayRow,tomorrowRow,headers};
    rowsEl.innerHTML='';

    const slots=[];
    for(const p of PRS){
      const col=headers.find(h=>norm(h)===norm(p));
      const tToday=col?todayRow.row[col]:'';
      const tTomorrow=col?tomorrowRow?.row[col]:'';
      slots.push({label:p,today:tToday,tomorrow:tTomorrow});
    }

    const now=new Date();
    const isFriToday=now.getDay()===5;
    const dhuhr=slots.find(s=>isDhuhr(s.label));
    if(dhuhr&&isFriToday) dhuhr.today='';

    slots.forEach(s=>{
      const el=document.createElement('div');
      el.className='row';
      el.innerHTML=`<div class="name">${s.label}</div>
                    <div class="time">${displayHHMM(s.today)}</div>
                    <div class="tomorrow">${displayHHMM(s.tomorrow)}</div>`;
      rowsEl.appendChild(el);
    });
  }

  async function init(){
    try{
      const resp=await fetch(AUTO_FILE);
      const text=await resp.text();
      const {headers,data}=parseCSV(text);
      const today=getRowForOffset(data,headers,0);
      const tomorrow=getRowForOffset(data,headers,1);
      render(today,tomorrow,headers);
      statusEl.textContent=`Loaded ${AUTO_FILE} (${data.length} rows)`;
    }catch(e){
      statusEl.textContent='Failed to load CSV.';
    }
  }
  init();
})();
</script>
</body>
</html>
