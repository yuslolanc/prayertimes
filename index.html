<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Iqamah Times</title>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">

<style>
  :root{
    /* palette */
    --bg:#ffffff; 
    --panel:#12181b; 
    --accent:#3b82f6;
    --muted:#97a3af; 
    --text:#0b1418;
    --cardText:#e8f0f2;

    /* title blue — tweak to your logo's exact dark blue if needed */
    --logo-blue:#0b5a8f;

    /* populated dynamically from banner image heights */
    --topPad:140px;      /* fallback before images load */
    --bottomPad:120px;   /* fallback before images load */
  }

  *{ box-sizing:border-box }

  /* lock the page — no browser scrollbar */
  html, body{
    height:100%;
    margin:0;
    overflow:hidden;
    font-family:ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
    color:var(--text);
    background:#fff;
  }

  /* fixed banners (scale responsively) */
  #topBanner, #bottomBanner{
    position:fixed;
    left:0;
    width:100%;
    height:auto;
    pointer-events:none;
    z-index:0;
    display:block;
  }
  #topBanner{ top:0; }
  #bottomBanner{ bottom:0; }

  /* keep content above banners */
  .shell{
    position:fixed;
    z-index:1;
    top:    calc(var(--topPad) + 20px);
    bottom: calc(var(--bottomPad) + 20px);
    left:22px; right:22px;

    display:flex; 
    flex-direction:column; 
    gap:18px;
    overflow:hidden;
    color:var(--cardText);
  }

  /* ===== MAST (logo + clock + dates) ===== */
  .mast{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  .mast .logo{
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .mast .logo img{
    height:120px;
    width:auto;
    object-fit:contain;
    border-radius:18px;
    background:#fff;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
  }
  #clockNow{
    margin: 6px auto 0 auto;
    text-align:center;
    font-size: clamp(36px, 7vw, 72px);
    font-weight:900;
    letter-spacing:2px;
    width:auto;
    max-width:92%;
    color:var(--text);
  }
  .datesRow{
    width:min(1100px, 92vw);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top:4px;
    font-size: clamp(14px, 2.3vw, 22px);
    font-weight:700;
  }
  .datesRow .chip{
    padding:10px 14px;
    border-radius:12px;
    background:#f3f6f8;
    color:#0c1b22;
    min-width:40%;
    text-align:center;
  }

  /* ===== Section title ===== */
  .section-title{
    text-align:center;
    margin-top:4px;
    margin-bottom:2px;
  }
  .section-title h1{
    font-size: clamp(22px, 4.4vw, 44px);
    font-weight:800;
    letter-spacing:.3px;
    margin:0;
    color:var(--logo-blue);
    text-transform:capitalize; /* Iqamah Times */
  }

  /* Cards / visuals */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    background-color:rgba(10,12,12,.70);
    border:1px solid rgba(255,255,255,.10); 
    border-radius:22px; 
    box-shadow:0 14px 36px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter:blur(10px) saturate(120%);
  }

  .table.card{ padding:0; overflow:hidden }
  .thead{ display:grid; grid-template-columns:2fr 1fr 1fr; gap:0; padding:16px 18px; background:rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.08) }
  .thead div{ font-size:34px; color:var(--muted); font-weight:700; letter-spacing:.4px }
  .rows{ display:flex; flex-direction:column }
  .row{ display:grid; grid-template-columns:2fr 1fr 1fr; align-items:center; gap:0; padding:20px 18px; border-top:1px solid rgba(255,255,255,.08) }
  .row .name{ font-size:30px; font-weight:800 }
  .row .time{ font-size:30px; font-weight:900; letter-spacing:.5px; display:flex; flex-direction:column; }
  .row .tomorrow{ justify-self:end; font-weight:900; font-size:24px; color:#bfdbfe }
  .row.next{ position:relative; background:linear-gradient(90deg, rgba(59,130,246,.10), rgba(255,255,255,0)); }
  .row.next::after{ content:''; position:absolute; inset:0; outline:3px solid var(--accent); border-radius:16px; opacity:.35; pointer-events:none }
  .inlinecd{ margin-top:6px; font-size:15px; font-weight:800; letter-spacing:.5px; color:#bfdbfe; opacity:.95; }

  .footer-card{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 12px;
    margin-top: auto;
    box-shadow: 0 6px 18px rgba(0,0,0,.25) inset, 0 8px 20px rgba(0,0,0,.25);
  }
  .footer-card a{ display:block; }
  .footer-card a:hover{ cursor:pointer; }
  .footer-card img{ display:block; width:100%; height:auto; border-radius:10px; }

  /* responsive insets (match old paddings) */
  @media (max-width: 900px) {
    .shell { 
      top:    calc(var(--topPad) + 16px);
      bottom: calc(var(--bottomPad) + 16px);
      left:16px; right:16px; gap:16px;
    }
    .mast .logo img { height: 108px; }
    #clockNow { font-size: 42px; }
    .thead div { font-size: 28px; }
    .row { padding: 16px; }
    .row .name, .row .time { font-size: 26px; }
    .row .tomorrow { font-size: 20px; }
  }
  @media (max-width: 600px) {
    .shell { 
      top:    calc(var(--topPad) + 12px);
      bottom: calc(var(--bottomPad) + 12px);
      left:12px; right:12px; gap:12px;
    }
    #clockNow { font-size: 34px; }
    .thead { grid-template-columns: 1.2fr 1fr; padding:12px; }
    .thead div:last-child { display:none; }
    .row { grid-template-columns: 1.2fr 1fr; padding:12px; }
    .row .tomorrow { display:none; }
    .row .name, .row .time { font-size:22px; }
    .inlinecd { font-size:12px; }
    .footer-card { padding:8px; border-radius:10px; }
    .footer-card img { border-radius:6px; }
  }
  @media (max-width: 380px) {
    #clockNow { font-size: 30px; }
    .row .name, .row .time { font-size: 20px; }
  }
</style>
</head>
<body>

  <!-- Fixed responsive banners -->
  <img id="topBanner" src="top_banner.png" alt="">
  <img id="bottomBanner" src="bottom_banner.png" alt="">

  <!-- Content region pinned between banners -->
  <div class="shell">

    <!-- ===== New mast: logo + clock + dates ===== -->
    <div class="mast">
      <div class="logo">
        <img src="./logo.png" alt="Masjid al Noor Logo" onerror="this.style.display='none'"/>
      </div>

      <!-- Clock -->
      <div id="clockNow">--:--</div>

      <!-- Dates row -->
      <div class="datesRow">
        <div class="chip" id="dateUK">—</div>
        <div class="chip" id="dateHijri">—</div>
      </div>
    </div>

    <!-- Section title -->
    <div class="section-title">
      <h1>Iqamah Times</h1>
    </div>

    <!-- Table -->
    <div class="table card">
      <div class="thead">
        <div>Salah</div><div>Iqamah</div><div style="text-align:right">Tomorrow</div>
      </div>
      <div class="rows" id="rows"></div>
    </div>

    <div id="status" style="display:none; min-width:260px; text-align:right; color:var(--muted);"></div>

    <div class="footer-card">
      <a href="https://www.whatsapp.com/channel/0029Vb6qOgq9MF8xjuiinL1f" target="_blank" rel="noopener">
        <img src="whatsapp.png" alt="Join our WhatsApp Channel – Masjid al Noor">
      </a>
    </div>

  </div>

<script>
(() => {
  /* Measure banner heights and update CSS variables */
  const root = document.documentElement;
  const tImg = document.getElementById('topBanner');
  const bImg = document.getElementById('bottomBanner');

  function setPads(){
    requestAnimationFrame(() => {
      const th = tImg ? tImg.getBoundingClientRect().height : 0;
      const bh = bImg ? bImg.getBoundingClientRect().height : 0;
      root.style.setProperty('--topPad',    Math.round(th) + 'px');
      root.style.setProperty('--bottomPad', Math.round(bh) + 'px');
    });
  }
  ['load','resize','orientationchange'].forEach(evt =>
    window.addEventListener(evt, setPads)
  );
  [tImg, bImg].forEach(img => {
    if (!img) return;
    if (img.complete) setPads();
    else img.addEventListener('load', setPads, { once:true });
  });
  setPads();

  /* ===== Kiosk app logic ===== */
  const TZ = 'Europe/London';
  const STORAGE_KEY  = 'kioskCSVTextV8';
  const STORAGE_NAME = 'kioskCSVNameV8';
  const AUTO_FILE    = './prayertime.csv';

  const rowsEl = document.getElementById('rows');
  const statusEl = document.getElementById('status');
  const clockEl  = document.getElementById('clockNow');
  const dateUKEl = document.getElementById('dateUK');
  const dateHijriEl = document.getElementById('dateHijri');

  function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }
  function fmtTime(d){ return new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:TZ}).format(d); }
  function fmtDateLong(d){ return new Intl.DateTimeFormat('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric',timeZone:TZ}).format(d); }
  function fmtHijri(d){
    try{
      const f = new Intl.DateTimeFormat('en-GB-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric',timeZone:TZ});
      const out = f.format(d);
      // Guard: if browser falls back to Gregorian
      if(/January|February|March|April|May|June|July|August|September|October|November|December/.test(out)) return '—';
      return out.replace(' AH',' AH');
    }catch(e){ return '—'; }
  }
  function tick(){
    const now=new Date();
    if(clockEl) clockEl.textContent = fmtTime(now);
    if(dateUKEl) dateUKEl.textContent = fmtDateLong(now);
    if(dateHijriEl) dateHijriEl.textContent = fmtHijri(now);
  }
  tick(); setInterval(tick,1000);

  /* CSV parsing (robust) */
  function cleanText(t){ return (t||'').replace(/^﻿/, '').replace(/\u0000/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n'); }
  function firstNonEmptyLine(text){ return text.split(/\n/).map(l=>l.trim()).find(l=>l.length>0) || ''; }
  function detectDelimiter(text){
    const header = firstNonEmptyLine(text);
    const cands=[',',';','\t','|']; let best=',', n=0;
    for(const d of cands){ const m=(header.split(d).length-1); if(m>n){best=d;n=m;} }
    return best;
  }
  function parseCSV(text){
    text = cleanText(text);
    if(!text.trim()) return {headers:[], data:[]};
    const delim = detectDelimiter(text);
    const rows=[]; let cur='', row=[], inQ=false;
    for(let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if(inQ){
        if(c==='"' && n==='"'){cur+='"'; i++;}
        else if(c==='"'){inQ=false;}
        else{cur+=c;}
      }else{
        if(c==='"'){inQ=true;}
        else if(c===delim){ row.push(cur); cur=''; }
        else if(c==='\n'){
          if(cur.length || row.some(x => (x||'').trim()!=='')){ row.push(cur); rows.push(row); }
          row=[]; cur='';
        }else{ cur+=c; }
      }
    }
    if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
    while(rows.length && rows[0].every(x => String(x||'').trim()==='')) rows.shift();
    if(!rows.length) return {headers:[], data:[]};
    const headers = rows[0].map(h => String(h||'').replace(/^﻿/,'').trim());
    const data = rows.slice(1)
      .filter(r => r.some(x => (x||'').trim()!==''))
      .map(r => Object.fromEntries(headers.map((h,i)=>[h, r[i]??''])));
    return {headers, data, delim};
  }

  const usedCols = new Set();
  function claim(col){ if(col) usedCols.add(col); return col; }
  function findPrayerHeader(headers, p){
    const hl = headers.map(h => [h, String(h||'').toLowerCase()]);
    const syn = {
      'FAJR':   [/fajr/],
      'DHUHR':  [/dhuhr/, /dhur/, /duhr/, /zuhr/, /zuhur/],
      'ASR':    [/asr/],
      'MAGHRIB':[/maghrib/, /magrib/],
      'ISHA':   [/isha/, /ishaa/, /isha'?a?/]
    }[p.toUpperCase()] || [new RegExp(p.toLowerCase())];
    let candidates = hl.filter(([h,l]) => !usedCols.has(h) && syn.some(rx => rx.test(l)));
    if(candidates.length){
      candidates.sort((a,b)=>{
        const aw = (/iqama?h?/.test(a[1])||/jama?a?h?/.test(a[1])) ? 1:0;
        const bw = (/iqama?h?/.test(b[1])||/jama?a?h?/.test(b[1])) ? 1:0;
        return bw - aw;
      });
      return claim(candidates[0][0]);
    }
    return null;
  }

  function parseDate(s){
    if(!s) return null;
    s = String(s).trim();
    const nowYear = (new Date()).getFullYear();
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?$/);
    if (m) {
      const d  = +m[1], mo = +m[2];
      const y  = m[3] ? (+m[3] < 100 ? 2000 + +m[3] : +m[3]) : nowYear;
      return new Date(y, mo - 1, d);
    }
    m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3]);
    const t = Date.parse(s);
    return isNaN(t) ? null : new Date(t);
  }
  function findDateCol(headers){
    return headers.find(h=>((h||'').toLowerCase().replace(/[\s_\-]/g,'').trim())==='date') || headers[0];
  }
  function getRowForOffset(rows, headers, offset){
    const dc=findDateCol(headers);
    const base=new Date();
    const target=new Date(base.getFullYear(), base.getMonth(), base.getDate()+offset);
    const tDay = target.getDate(), tMonth = target.getMonth();
    for(const r of rows){
      const d=parseDate(r[dc]); if(!d) continue;
      if(d.getDate()===tDay && d.getMonth()===tMonth){
        return {row:r, dateHeader:dc};
      }
    }
    return null;
  }
  function displayHHMM(s){
    if(!s) return '';
    const m = String(s).match(/(\d{1,2}):(\d{2})/);
    return m ? `${m[1].padStart(2,'0')}:${m[2]}` : String(s);
  }
  function parseTimeToToday(s){
    if(!s) return null; s=String(s).trim().toLowerCase().replace(/\./g,':');
    let m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*([ap]m))?$/); if(!m) return null;
    let h=+m[1], mi=+m[2], se=m[3]?+m[3]:0;
    if(m[4]==='pm'&&h<12)h+=12; if(m[4]==='am'&&h===12)h=0;
    const t=new Date(); t.setHours(h,mi,se,0); return t;
  }
  let cdTimer=null, lastNextTime=null;
  function startCountdown(nextTime){
    if(cdTimer) clearInterval(cdTimer);
    lastNextTime = nextTime;
    function tickCD(){
      const el = document.getElementById('inlineCD');
      if(!el || !lastNextTime){ return; }
      let diff = Math.floor((lastNextTime - new Date())/1000);
      if(diff < 0) diff = 0;
      const h=Math.floor(diff/3600), m=Math.floor((diff%3600)/60), s=diff%60;
      el.textContent = `T-${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      if(diff === 0){
        clearInterval(cdTimer);
      }
    }
    tickCD();
    cdTimer = setInterval(tickCD, 1000);
  }

  function render(todayRow, tomorrowRow, headers){
    const rowsEl = document.getElementById('rows');
    rowsEl.innerHTML='';
    usedCols.clear();
    const slots=[];
    const PRS=['Fajr','Dhuhr','Asr','Maghrib','Isha'];

    for(const p of PRS){
      const col=findPrayerHeader(headers,p);
      const tToday = col? String(todayRow.row[col]||'').trim():'';
      const tTomorrow = col? String(tomorrowRow?.row?.[col]||'').trim():'';
      if(tToday || tTomorrow) slots.push({label:p, today:tToday, tomorrow:tTomorrow});
    }

    const now = new Date();
    const isFriToday = now.getDay()===5;
    const theTomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
    const isFriTomorrow = theTomorrow.getDay()===5;

    const isDhuhrName = s => ['dhuhr','dhur','zuhr','zuhur','duhr'].includes((s||'').toLowerCase());
    const dhuhr = slots.find(s => isDhuhrName(s.label));
    if(dhuhr){ if(isFriToday) dhuhr.today=''; if(isFriTomorrow) dhuhr.tomorrow=''; }

    const findExact = (headers, key)=>{
      const target = (key||'').toLowerCase().replace(/[\s_\-]/g,'').trim();
      return headers.find(h => (h||'').toLowerCase().replace(/[\s_\-]/g,'').trim() === target) || null;
    };
    const hJ1 = findExact(headers,'jumuah1') || findExact(headers,'jummah1') || findExact(headers,'jumuah_1') || findExact(headers,'jummah_1');
    const hJ2 = findExact(headers,'jumuah2') || findExact(headers,'jummah2') || findExact(headers,'jumuah_2') || findExact(headers,'jummah_2');
    const fmtPair=(t1,t2)=>[displayHHMM(t1),displayHHMM(t2)].filter(Boolean).join(' · ');
    if(isFriToday && (hJ1 || hJ2)){
      const combined = fmtPair(hJ1?todayRow.row[hJ1]:'', hJ2?todayRow.row[hJ2]:'');
      if(combined) slots.splice(1,0,{label:'Jummah 1/2', today:combined, tomorrow:'', jumuah:true});
    }
    if(isFriTomorrow && (hJ1 || hJ2)){
      const combined = fmtPair(hJ1&&tomorrowRow?tomorrowRow.row[hJ1]:'', hJ2&&tomorrowRow?tomorrowRow.row[hJ2]:'');
      if(combined) slots.push({label:'Jummah 1/2', today:'', tomorrow:combined, jumuah:true});
    }

    let nextIdx=-1, nextTime=null;
    const parsed = slots.map((s,i)=>{
      let d=null;
      if(s.jumuah && s.today){
        const first = String(s.today).split('·')[0].trim();
        d=parseTimeToToday(first);
      }else{
        d=parseTimeToToday(s.today);
      }
      if(d && d>new Date() && (!nextTime || d<nextTime)){ nextTime=d; nextIdx=i; }
      return {...s, date:d};
    });
    if(nextIdx===-1){
      const fajrIdx = parsed.findIndex(x=>((x.label||'').toLowerCase())==='fajr' && x.today);
      if(fajrIdx>=0){
        const d = parseTimeToToday(parsed[fajrIdx].today);
        if(d){ nextIdx=fajrIdx; nextTime=new Date(d.getTime()+24*3600*1000); }
      }
    }

    parsed.forEach((s,i)=>{
      const n = (s.label||'').toLowerCase();
      const left = n==='fajr'?'Fajr': n==='dhuhr'||n==='dhur'||n==='zuhr'||n==='zuhur'?'Dhuhr'
                  : n==='asr'?'Asr': n==='maghrib'?'Maghrib': n==='isha'?'Isha': s.label;
      const isNext = i===nextIdx;
      const timeHTML = s.jumuah ? s.today : displayHHMM(s.today);
      const cdHTML = isNext ? `<div class="inlinecd" id="inlineCD">T---:--:--</div>` : '';
      const el=document.createElement('div');
      el.className='row'+(isNext?' next':'');
      el.innerHTML = `<div class="name">${left}</div>
                      <div class="time">${timeHTML}${cdHTML}</div>
                      <div class="tomorrow">${s.jumuah ? s.tomorrow : displayHHMM(s.tomorrow)}</div>`;
      rowsEl.appendChild(el);
    });

    if(nextTime){ startCountdown(nextTime); }
    else{
      if(cdTimer) clearInterval(cdTimer);
      const el = document.getElementById('inlineCD');
      if(el) el.textContent = 'T---:--:--';
    }
  }

  function loadFromText(csvText, name='(pasted)'){
    try{
      const {headers,data}=parseCSV(csvText);
      if(!headers.length || !data.length){ setStatus('CSV empty.'); return; }
      const today  = getRowForOffset(data, headers, 0);
      const tomorrow = getRowForOffset(data, headers, 1);
      if(!today){
        const dc=findDateCol(headers);
        const sample=data.slice(0,5).map(r=>r[dc]).join(' | ');
        setStatus(`Could not match today. Samples: ${sample}`);
        return;
      }
      setStatus(`Loaded ${name} (${data.length} rows)`);
      render(today, tomorrow, headers);
      localStorage.setItem(STORAGE_KEY,csvText);
      localStorage.setItem(STORAGE_NAME,name);
    }catch(e){ console.error(e); setStatus('Failed to read CSV.'); }
  }

  async function tryLoadFromServer(){
    if(!location.protocol.startsWith('http')) return false;
    try{
      const resp = await fetch(AUTO_FILE + '?t=' + Date.now(), {cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const t = await resp.text();
      setStatus('Loaded prayertime.csv from server');
      loadFromText(t,'prayertime.csv');
      return true;
    }catch(e){
      console.warn('Fetch failed, will use cached if available', e);
      return false;
    }
  }

  (async function init(){
    const cached=localStorage.getItem(STORAGE_KEY);
    const name=localStorage.getItem(STORAGE_NAME)||'cached.csv';
    const ok = await tryLoadFromServer();
    if(!ok && cached){
      setStatus(`Offline mode — showing last saved: ${name}`);
      loadFromText(cached,name);
    }
    if(!ok && !cached){
      setStatus('Waiting for CSV…');
    }
  })();

  function msToMidnight(){ const n=new Date(); const x=new Date(n); x.setHours(24,0,0,0); return x-n; }
  setTimeout(()=>location.reload(), msToMidnight()+5000);
})();
</script>
</body>
</html>
