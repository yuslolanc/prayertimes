<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Masjid al Noor • Iqamah Times</title>
<style>
  :root{
    --bg:#0a0f0f; 
    --panel:#12181b; 
    --accent:#3b82f6;  /* BLUE accent */
    --muted:#97a3af; 
    --text:#e8f0f2;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;color:var(--text)}
  body{background: radial-gradient(1000px 600px at 70% -10%, rgba(59,130,246,.15) 0%, rgba(0,0,0,.65) 45%, rgba(0,0,0,.85) 100%);}
  .shell{position:relative; min-height:100%; padding:18px; display:flex; flex-direction:column; gap:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)); background-color:rgba(10,12,12,.65);
        border:1px solid rgba(255,255,255,.08); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
        backdrop-filter:blur(10px) saturate(120%);}

  /* Top digital clock */
  #clockNow {
    margin: 0 auto 10px auto;
    text-align: center;
    font-size: 42px;
    font-weight: 900;
    letter-spacing: 2px;
    width: 148px;
    max-width: 90%;
  }

  /* Header */
  .header.card{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    padding:14px 16px;
  }
  .header .center{
    grid-column:2;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  }
  .logo{
    height:112px; width:112px;
    object-fit:contain; border-radius:16px; background:rgba(255,255,255,.06)
  }
  .titles{display:flex; flex-direction:column; gap:6px; text-align:center}
  .title{font-size:36px; font-weight:800; letter-spacing:.3px}
  .subtitle{font-size:14px; color:var(--muted)}

  /* Date chip */
  .datechip{
    grid-column:3; justify-self:end;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:18px 24px; border-radius:18px; background:var(--panel);
    border:1px solid rgba(255,255,255,.08); min-width:360px; text-align:center;
    font-weight:800; font-size:30px; line-height:1.2;
  }
  .datechip small{display:block; font-size:27px; color:var(--muted); font-weight:700; margin-top:2px}
  .datechip .hijri{display:block; font-size:24px; color:#bfdbfe; font-weight:800; margin-top:6px; letter-spacing:.2px}

  /* Table */
  .table.card{padding:0; overflow:hidden}
  .thead{display:grid; grid-template-columns:2fr 1fr 1fr; gap:0; padding:14px 16px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.06)}
  .thead div{font-size:32px; color:var(--muted); font-weight:700; letter-spacing:.4px}
  .rows{display:flex; flex-direction:column}
  .row{display:grid; grid-template-columns:2fr 1fr 1fr; align-items:center; gap:0; padding:18px 16px; border-top:1px solid rgba(255,255,255,.06)}
  .row .name{font-size:28px; font-weight:800}
  .row .time{font-size:28px; font-weight:900; letter-spacing:.5px; display:flex; flex-direction:column;}
  .row .tomorrow{justify-self:end; font-weight:900; font-size:22px; color:#bfdbfe}
  .row.next{position:relative; background:linear-gradient(90deg, rgba(59,130,246,.08), rgba(255,255,255,0));}
  .row.next::after{content:''; position:absolute; inset:0; outline:3px solid var(--accent); border-radius:14px; opacity:.35; pointer-events:none}
  .inlinecd{ margin-top:6px; font-size:14px; font-weight:800; letter-spacing:.5px; color:#bfdbfe; opacity:.95;}

  /* WhatsApp CTA card */
  .cta.card{
    display:grid; gap:16px; align-items:center; padding:16px 18px;
    grid-template-columns: 1fr auto;
  }
  .ctaHeader{display:flex; align-items:center; gap:12px}
  .waLogo{width:28px; height:28px; display:block}
  .cta h3{margin:0 0 6px 0; font-size:20px; font-weight:900; letter-spacing:.3px}
  .cta p{margin:0; font-size:14px; color:var(--muted)}
  .cta .actions{margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
    border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(59,130,246,.12);
    color:#eaf2ff; text-decoration:none; font-weight:800; font-size:14px;
  }
  .btn:hover{background:rgba(59,130,246,.18)}
  .qrwrap{
    justify-self:end; display:grid; place-items:center;
    padding:12px; border-radius:14px;
    background:white;   /* white inner card */
    border:2px solid rgba(0,0,0,.2);
  }
  .qrwrap .qr{width:168px; height:168px; display:block}
  .qrwrap small{margin-top:6px; color:#0a0f0f; font-weight:800}
  @media (max-width: 480px) {
    .cta.card{grid-template-columns:1fr}
    .qrwrap{justify-self:start}
  }
</style>
</head>
<body>
  <div class="shell">

    <!-- Top digital clock -->
    <div id="clockNow">--:--</div>

    <div class="header card">
      <div></div>
      <div class="center">
        <img class="logo" src="./logo.png" alt="Logo" onerror="this.style.display='none'"/>
        <div class="titles">
          <div class="title">Masjid al Noor - Iqamah Times</div>
        </div>
      </div>
      <div class="datechip" id="datechip">
        <small>—</small>
        <span class="hijri" id="hijri">—</span>
      </div>
    </div>

    <div class="table card">
      <div class="thead">
        <div>Salah</div><div>Iqamah</div><div style="text-align:right">Tomorrow</div>
      </div>
      <div class="rows" id="rows"></div>
    </div>

    <!-- WhatsApp Channel CTA -->
    <div class="cta card">
      <div>
        <div class="ctaHeader">
          <!-- WhatsApp logo -->
          <svg class="waLogo" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="#25D366" d="M12.04 0C5.42 0 .04 5.38.04 12c0 2.1.54 4.14 1.61 5.95L0 24l6.41-1.67A11.96 11.96 0 0 0 12.04 24C18.66 24 24 18.62 24 12S18.66 0 12.04 0z"/>
            <path fill="#FFF" d="M19.5 14.08c-.07.2-.35 1.02-1.3 1.62-.68.43-1.55.6-2.58.37-1.84-.41-4.06-1.94-5.37-3.83-1.2-1.74-1.38-3.2-1.25-4.06.08-.55.55-1.28.96-1.6.28-.22.6-.2.77-.17.2.04.5.18.77.9.1.26.25.6.35.83.18.4.04.65-.08.84-.12.18-.27.4-.41.57-.13.18-.27.37-.11.67.17.31.73 1.2 1.58 1.95 1.1.95 1.98 1.26 2.32 1.4.35.14.56.12.75-.07.2-.2.85-.99 1.07-1.33.22-.33.45-.28.75-.16.3.11 1.94.91 2.28 1.08.34.17.56.25.65.4.08.16.08.36 0 .51z"/>
          </svg>
          <h3 style="margin:0">Join our WhatsApp Channel</h3>
        </div>
        <p>Stay up to date with the latest events, announcements, and news from Masjid al Noor.</p>
        <div class="actions">
          <a class="btn" id="waBtn" href="#" target="_blank" rel="noopener">
            Join Channel
          </a>
          <span style="font-size:13px; color:#aab4bf; user-select:all" id="waUrlText"></span>
        </div>
      </div>
      <div class="qrwrap">
        <div id="waQR" class="qr" aria-label="WhatsApp Channel QR"></div>
        <small>Scan to join</small>
      </div>
    </div>

    <div id="status" style="min-width:260px; text-align:right; color:var(--muted);"></div>
  </div>

<script>
(() => {
  const TZ = 'Europe/London';
  const STORAGE_KEY  = 'kioskCSVTextV7';
  const STORAGE_NAME = 'kioskCSVNameV7';
  const AUTO_FILE    = './prayertime.csv';
  const WA_URL = 'https://www.whatsapp.com/channel/0029Vb6qOgq9MF8xjuiinL1f';

  /* Canonical labels */
  const PRS = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];

  const rowsEl = document.getElementById('rows');
  const datechip = document.getElementById('datechip');
  const statusEl = document.getElementById('status');
  const clockEl  = document.getElementById('clockNow');

  /* WhatsApp CTA setup */
  const waBtn = document.getElementById('waBtn');
  const waQR  = document.getElementById('waQR');
  const waUrlText = document.getElementById('waUrlText');
  if(waBtn){ waBtn.href = WA_URL; }
  if(waUrlText){ waUrlText.textContent = WA_URL; }

  const norm = s => (s||'').toLowerCase().replace(/[\s_\-]/g,'').trim();
  const isDhuhr = s => ['dhuhr','dhur','zuhr','zuhur','duhr'].includes(norm(s));

  let cdTimer = null, lastNextTime = null, cache = null;

  function fmtTime(d){ return new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:TZ}).format(d); }
  function fmtDateLong(d){ return new Intl.DateTimeFormat('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric',timeZone:TZ}).format(d); }

  // Hijri (Umm al-Qura) with fallback
  function fmtHijri(d){
    try{
      const f = new Intl.DateTimeFormat('en-GB-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric',timeZone:TZ});
      const out = f.format(d);
      if(/January|February|March|April|May|June|July|August|September|October|November|December/.test(out)) return approxHijri(d);
      return out.replace(' AH',' AH');
    }catch(e){ return approxHijri(d); }
  }
  function approxHijri(g){
    const months = ["Muharram","Safar","Rabiʿ al-Awwal","Rabiʿ al-Thani","Jumada al-Ula","Jumada al-Akhira","Rajab","Shaʿban","Ramadan","Shawwal","Dhu al-Qaʿdah","Dhu al-Hijjah"];
    const day = g.getUTCDate(); const month = g.getUTCMonth()+1; const year = g.getUTCFullYear();
    const jd = Math.floor((1461*(year+4800-Math.floor((14-month)/12)))/4) + Math.floor((367*(month-2-12*Math.floor((14-month)/12)))/12) - Math.floor((3*Math.floor((year+4900-Math.floor((14-month)/12))/100))/4) + day - 32075;
    const islamic = Math.floor((jd - 1948439.5) / 29.530588861);
    const iMonth = Math.max(1, Math.min(12, Math.floor((jd - 1948439.5 - islamic*29.530588861) / 29.530588861 * 12) + 1));
    const iDay   = Math.max(1, Math.min(30, Math.floor(jd - (islamic*29.530588861 + 1948439.5) + 1)));
    const iYear  = Math.floor((islamic + 8) / 12) + 1 + 1440 - 1;
    return \`\${months[iMonth-1]} \${iDay}, \${iYear} AH\`;
  }

  function tick(){
    const now=new Date();
    const timeNow = fmtTime(now);
    if(clockEl) clockEl.textContent = timeNow;
    datechip.innerHTML =
      '<small>'+fmtDateLong(now)+'</small>' +
      '<span class="hijri">'+fmtHijri(now)+'</span>';
  }
  tick(); setInterval(tick,1000);

  /* CSV helpers */
  function cleanText(t){
    if(!t) return '';
    t = t.replace(/^﻿/, '').replace(/\\u0000/g,'');
    t = t.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n');
    return t;
  }
  function firstNonEmptyLine(text){
    const lines = text.split(/\\n/).map(l=>l.trim());
    return lines.find(l => l.length>0) || '';
  }
  function detectDelimiter(text){
    const header = firstNonEmptyLine(text);
    const cands=[',',';','\\t','|'];
    let best=',', n=0;
    for(const d of cands){ const m=(header.split(d).length-1); if(m>n){best=d;n=m;} }
    return best;
  }
  function parseCSV(text){
    text = cleanText(text);
    if(!text.trim()) return {headers:[], data:[]};
    const delim = detectDelimiter(text);
    const rows=[]; let cur='', row=[], inQ=false;
    for(let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if(inQ){
        if(c==='"' && n==='"'){cur+='"'; i++;}
        else if(c==='"'){inQ=false;}
        else{cur+=c;}
      }else{
        if(c==='"'){inQ=true;}
        else if(c===delim){ row.push(cur); cur=''; }
        else if(c==='\\n'){
          if(cur.length || row.some(x => (x||'').trim()!=='')){ row.push(cur); rows.push(row); }
          row=[]; cur='';
        }else{ cur+=c; }
      }
    }
    if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
    while(rows.length && rows[0].every(x => String(x||'').trim()==='')) rows.shift();
    if(!rows.length) return {headers:[], data:[]};
    const headers = rows[0].map(h => String(h||'').replace(/^﻿/,'').trim());
    const data = rows.slice(1).filter(r => r.some(x => (x||'').trim()!=='')).map(r => Object.fromEntries(headers.map((h,i)=>[h, r[i]??''])));
    return {headers, data, delim};
  }

  const usedCols = new Set();
  function claim(col){ if(col) usedCols.add(col); return col; }

  function findPrayerHeader(headers, p){
    const hl = headers.map(h => [h, String(h||'').toLowerCase()]);
    const syn = {
      'FAJR':   [/fajr/],
      'DHUHR':  [/dhuhr/, /dhur/, /duhr/, /zuhr/, /zuhur/],
      'ASR':    [/asr/],
      'MAGHRIB':[/maghrib/, /magrib/],
      'ISHA':   [/isha/, /ishaa/, /isha'?a?/]
    }[p.toUpperCase()] || [new RegExp(p.toLowerCase())];

    let candidates = hl.filter(([h,l]) => !usedCols.has(h) && syn.some(rx => rx.test(l)));
    if(candidates.length){
      candidates.sort((a,b)=>{
        const aw = (/iqama?h?/.test(a[1])||/jama?a?h?/.test(a[1])) ? 1:0;
        const bw = (/iqama?h?/.test(b[1])||/jama?a?h?/.test(b[1])) ? 1:0;
        return bw - aw;
      });
      return claim(candidates[0][0]);
    }
    const target = norm(p);
    let best=null, score=-1;
    for(const h of headers){
      if(usedCols.has(h)) continue;
      const n=norm(h);
      let sc=0;
      if(n===target) sc+=100;
      if(n.startsWith(target)) sc+=50;
      if(n.includes(target)) sc+=10;
      if(/iqama?h?/.test(n)) sc+=3;
      if(/jama?a?t/.test(n)) sc+=1;
      if(sc>score){score=sc; best=h;}
    }
    return claim(score>0?best:null);
  }

  function parseDate(s){
    if(!s) return null; s=String(s).trim();
    let m=s.match(/^(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{4})$/); if(m) return new Date(+m[3], +m[2]-1, +m[1]);
    m=s.match(/^(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2})$/); if(m) return new Date(2000+ +m[3], +m[2]-1, +m[1]);
    m=s.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/); if(m) return new Date(+m[1], +m[2]-1, +m[3]);
    const t=Date.parse(s); return isNaN(t)?null:new Date(t);
  }
  function sameDay(a,b){ return a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function findDateCol(headers){ return headers.find(h=>norm(h)==='date') || headers[0]; }
  function getRowForOffset(rows, headers, offset){
    const dc=findDateCol(headers);
    const base=new Date();
    const target=new Date(base.getFullYear(), base.getMonth(), base.getDate()+offset);
    for(const r of rows){
      const d=parseDate(r[dc]); if(!d) continue;
      if(sameDay(d,target)) return {row:r, dateHeader:dc};
    }
    return null;
  }
  function displayHHMM(s){
    if(!s) return '';
    const m = String(s).match(/(\\d{1,2}):(\\d{2})/);
    return m ? \`\${m[1].padStart(2,'0')}:\${m[2]}\` : String(s);
  }
  function parseTimeToToday(s){
    if(!s) return null; s=String(s).trim().toLowerCase().replace(/\\./g,':');
    let m=s.match(/^(\\d{1,2}):(\\d{2})(?::(\\d{2}))?(?:\\s*([ap]m))?$/); if(!m) return null;
    let h=+m[1], mi=+m[2], se=m[3]?+m[3]:0;
    if(m[4]==='pm'&&h<12)h+=12; if(m[4]==='am'&&h===12)h=0;
    const t=new Date(); t.setHours(h,mi,se,0); return t;
  }

  function startCountdown(nextTime){
    if(cdTimer) clearInterval(cdTimer);
    lastNextTime = nextTime;
    function tickCD(){
      const el = document.getElementById('inlineCD');
      if(!el || !lastNextTime){ return; }
      let diff = Math.floor((lastNextTime - new Date())/1000);
      if(diff < 0) diff = 0;
      const h=Math.floor(diff/3600), m=Math.floor((diff%3600)/60), s=diff%60;
      el.textContent = \`T-\${String(h).padStart(2,'0')}:\${String(m).padStart(2,'0')}:\${String(s).padStart(2,'0')}\`;
      if(diff === 0 && cache){
        clearInterval(cdTimer);
        render(cache.todayRow, cache.tomorrowRow, cache.headers);
      }
    }
    tickCD();
    cdTimer = setInterval(tickCD, 1000);
  }

  function render(todayRow, tomorrowRow, headers){
    cache = {todayRow, tomorrowRow, headers};

    rowsEl.innerHTML='';
    usedCols.clear();
    const slots=[];

    for(const p of PRS){
      const col=findPrayerHeader(headers,p);
      const tToday = col? String(todayRow.row[col]||'').trim():'';
      const tTomorrow = col? String(tomorrowRow?.row?.[col]||'').trim():'';
      if(tToday || tTomorrow) slots.push({label:p, today:tToday, tomorrow:tTomorrow});
    }

    const now = new Date();
    const isFriToday = now.getDay()===5;
    const isFriTomorrow = (new Date(now.getFullYear(), now.getMonth(), now.getDate()+1)).getDay()===5;

    const dhuhr = slots.find(s => isDhuhr(s.label));
    if(dhuhr){
      if(isFriToday)    dhuhr.today   = '';
      if(isFriTomorrow) dhuhr.tomorrow= '';
    }

    function findExact(headers, key){
      const target = norm(key);
      return headers.find(h => norm(h) === target) || null;
    }
    const hJ1 = findExact(headers,'jumuah1') || findExact(headers,'jummah1') || findExact(headers,'jumuah_1') || findExact(headers,'jummah_1');
    const hJ2 = findExact(headers,'jumuah2') || findExact(headers,'jummah2') || findExact(headers,'jumuah_2') || findExact(headers,'jummah_2');

    function fmtPair(t1,t2){
      const a=displayHHMM(t1), b=displayHHMM(t2);
      return [a,b].filter(Boolean).join(' · ');
    }
    if(isFriToday && (hJ1 || hJ2)){
      const t1 = hJ1 ? todayRow.row[hJ1] : '';
      const t2 = hJ2 ? todayRow.row[hJ2] : '';
      const combined = fmtPair(t1,t2);
      if(combined) slots.splice(1,0,{label:'Jummah 1/2', today:combined, tomorrow:'', jumuah:true});
    }
    if(isFriTomorrow && (hJ1 || hJ2)){
      const t1 = hJ1 && tomorrowRow ? tomorrowRow.row[hJ1] : '';
      const t2 = hJ2 && tomorrowRow ? tomorrowRow.row[hJ2] : '';
      const combined = fmtPair(t1,t2);
      if(combined) slots.push({label:'Jummah 1/2', today:'', tomorrow:combined, jumuah:true});
    }

    let nextIdx=-1, nextTime=null;
    const parsed = slots.map((s,i)=>{
      let d=null;
      if(s.jumuah && s.today){
        const first = String(s.today).split('·')[0].trim();
        d=parseTimeToToday(first);
      }else{
        d=parseTimeToToday(s.today);
      }
      if(d && d>new Date() && (!nextTime || d<nextTime)){ nextTime=d; nextIdx=i; }
      return {...s, date:d};
    });
    if(nextIdx===-1){
      const fajrIdx = parsed.findIndex(x=>norm(x.label)==='fajr' && x.today);
      if(fajrIdx>=0){
        const d = parseTimeToToday(parsed[fajrIdx].today);
        if(d){ nextIdx=fajrIdx; nextTime=new Date(d.getTime()+24*3600*1000); }
      }
    }

    parsed.forEach((s,i)=>{
      const n = norm(s.label);
      const left = n==='fajr'?'Fajr': n==='dhuhr'||n==='dhur'||n==='zuhr'||n==='zuhur'?'Dhuhr'
                  : n==='asr'?'Asr': n==='maghrib'?'Maghrib': n==='isha'?'Isha': s.label;

      const isNext = i===nextIdx;
      const timeHTML = s.jumuah ? s.today : displayHHMM(s.today);
      const cdHTML = isNext ? '<div class="inlinecd" id="inlineCD">T---:--:--</div>' : '';

      const el=document.createElement('div');
      el.className='row'+(isNext?' next':'');
      el.innerHTML = \`<div class="name">\${left}</div>
                      <div class="time">\${timeHTML}\${cdHTML}</div>
                      <div class="tomorrow">\${s.jumuah ? s.tomorrow : displayHHMM(s.tomorrow)}</div>\`;
      rowsEl.appendChild(el);
    });

    if(nextTime){
      startCountdown(nextTime);
    }else{
      if(cdTimer) clearInterval(cdTimer);
      const el = document.getElementById('inlineCD');
      if(el) el.textContent = 'T---:--:--';
    }
  }

  function loadFromText(csvText, name='(pasted)'){
    try{
      const {headers,data}=parseCSV(csvText);
      if(!headers.length || !data.length){ statusEl.textContent='CSV empty.'; return; }
      const today  = getRowForOffset(data, headers, 0);
      const tomorrow = getRowForOffset(data, headers, 1);
      if(!today){ const dc=findDateCol(headers); const sample=data.slice(0,5).map(r=>r[dc]).join(' | ');
        statusEl.innerHTML=\`<span style="color:#fca5a5">Could not match today.</span> Samples: \${sample}\`; return; }
      statusEl.textContent=\`Loaded \${name} (\${data.length} rows)\`;
      render(today, tomorrow, headers);
      localStorage.setItem(STORAGE_KEY,csvText);
      localStorage.setItem(STORAGE_NAME,name);
    }catch(e){ console.error(e); statusEl.textContent='Failed to read CSV.'; }
  }

  async function tryLoadFromServer(){
    if(!location.protocol.startsWith('http')) return false;
    try{
      const resp = await fetch(AUTO_FILE + '?t=' + Date.now(), {cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const t = await resp.text();
      statusEl.textContent='Loaded prayertime.csv from server';
      loadFromText(t,'prayertime.csv');
      return true;
    }catch(e){
      console.warn('Fetch failed, will use cached if available', e);
      return false;
    }
  }

  (async function init(){
    const cached=localStorage.getItem(STORAGE_KEY);
    const name=localStorage.getItem(STORAGE_NAME)||'cached.csv';
    const ok = await tryLoadFromServer();
    if(!ok && cached){
      statusEl.textContent=\`Offline mode — showing last saved: \${name}\`;
      loadFromText(cached,name);
    }
    if(!ok && !cached){
      statusEl.textContent='Waiting for CSV…';
    }
    makeWAQr(); // Build the QR offline
  })();

  function msToMidnight(){ const n=new Date(); const x=new Date(n); x.setHours(24,0,0,0); return x-n; }
  setTimeout(()=>location.reload(), msToMidnight()+5000);

  /* ----------------------- Offline QR generator -----------------------
     Minimal compact QR generator (byte mode, Level M), outputs inline SVG.
     Based on QR encoding principles; suitable for URLs and short text.
  ---------------------------------------------------------------------*/
  // Compact QR encoder (supports auto typeNumber up to 10, EC Level M, byte mode)
  // Tables (versions 1..10) for RS blocks (totalCount, dataCount) at EC levels L,M,Q,H
  function RS(total,data){this.totalCount=total;this.dataCount=data}
  const RS_TABLE=[
    [new RS(19,16),new RS(16,14),new RS(13,11),new RS(9,7)],
    [new RS(34,28),new RS(28,22),new RS(22,16),new RS(16,12)],
    [new RS(55,44),new RS(44,34),new RS(34,26),new RS(26,20)],
    [new RS(80,64),new RS(64,48),new RS(48,36),new RS(36,28)],
    [new RS(108,86),new RS(86,62),new RS(62,46),new RS(46,34)],
    [new RS(136,108),new RS(108,76),new RS(76,60),new RS(60,44)],
    [new RS(156,124),new RS(124,88),new RS(88,66),new RS(66,50)],
    [new RS(194,154),new RS(154,110),new RS(110,86),new RS(86,64)],
    [new RS(232,182),new RS(182,132),new RS(132,100),new RS(100,84)],
    [new RS(274,216),new RS(216,154),new RS(154,122),new RS(122,96)]
  ];
  const EC={L:0,M:1,Q:2,H:3}; // index into RS_TABLE row

  const GEXP=(function(){
    let EXP=new Array(512),LOG=new Array(256),x=1;
    for(let i=0;i<255;i++){ EXP[i]=x; LOG[x]=i; x<<=1; if(x&0x100) x^=0x11d; }
    for(let i=255;i<512;i++) EXP[i]=EXP[i-255];
    return {EXP,LOG};
  })();

  function gexp(n){return GEXP.EXP[n]}
  function glog(n){if(n<1) throw 'glog'; return GEXP.LOG[n]}

  function polyMul(p,q){
    const res=new Array(p.length+q.length-1).fill(0);
    for(let i=0;i<p.length;i++) for(let j=0;j<q.length;j++){
      res[i+j]^=gexp((glog(p[i])+glog(q[j]))%255);
    }
    return res;
  }
  function polyMod(p,q){
    p=p.slice();
    while(p.length>=q.length){
      const ratio=(glog(p[0])-glog(q[0])+255)%255;
      for(let i=0;i<q.length;i++) p[i]^=gexp((glog(q[i])+ratio)%255);
      while(p[0]===0) p.shift();
    }
    return p;
  }
  function rsGen(deg){
    let res=[1];
    for(let i=0;i<deg;i++) res=polyMul(res,[1,gexp(i)]);
    return res;
  }

  function bitBuffer(){ this.b=[]; this.len=0; }
  bitBuffer.prototype.put=function(num,length){ for(let i=length-1;i>=0;i--){ this.putBit((num>>>i)&1); } };
  bitBuffer.prototype.putBit=function(bit){ const i=this.len>>3; if(this.b.length<=i) this.b.push(0); if(bit) this.b[i]|=(0x80>>(this.len&7)); this.len++; };

  function QR(type,ecLevel){
    this.typeNumber=type||0; this.ecLevel=ecLevel; this.modules=null; this.moduleCount=0; this.data=[];
  }
  QR.prototype.addData=function(s){ this.data.push({mode:4, // byte mode
    getLength:()=>s.length, write:(bb)=>{ for(let i=0;i<s.length;i++) bb.put(s.charCodeAt(i),8); }, str:s}); };
  QR.prototype.make=function(){
    if(this.typeNumber<1){
      // pick smallest version that fits (up to 10)
      for(let v=1; v<=10; v++){ this.typeNumber=v; if(this._tryMake()) return; }
      this.typeNumber=10; this._tryMake();
    }else{ this._tryMake(); }
  };
  QR.prototype._tryMake=function(){
    const rs=RS_TABLE[this.typeNumber-1][EC.M]; // use Level M
    const totalData=rs.dataCount;
    const bb=new bitBuffer();
    for(const d of this.data){ bb.put(4,4); bb.put(d.getLength(),8); d.write(bb); }
    // terminator & pad to byte
    const maxBits=totalData*8;
    if(bb.len>maxBits) return false;
    const terminator=Math.min(4,maxBits-bb.len); bb.put(0,terminator);
    while(bb.len%8) bb.putBit(0);
    // padding
    const pads=[0xec,0x11]; let i=0;
    while((bb.len>>3)<totalData){ bb.put(pads[i++&1],8); }

    // error correction
    const gen=rsGen(rs.totalCount-rs.dataCount);
    const dataBytes=bb.b.slice(0,totalData);
    const mod=polyMod(dataBytes.concat(new Array(gen.length-1).fill(0)), gen);
    const codewords=dataBytes.concat(mod);

    // init matrix
    const n=this.typeNumber*4+17;
    this.moduleCount=n; this.modules=Array.from({length:n},()=>Array(n).fill(null));
    placeFinder(this,0,0); placeFinder(this,n-7,0); placeFinder(this,0,n-7);
    placeTiming(this);
    if(this.typeNumber>=2) placeAlignment(this);

    // map data (simple zig-zag)
    let row=n-1, col=n-1, dir=-1, bit=0, byte=0;
    while(col>0){
      if(col===6) col--; // skip timing column
      for(let r=0;r<n;r++){
        const rr = dir===-1 ? (row-r) : (col===6? r : r);
      }
      while(true){
        for(let c=0;c<2;c++){
          const cc=col-c; const rr=row;
          if(this.modules[rr][cc]===null){
            let dark=false;
            if(byte<codewords.length){ dark = ((codewords[byte]>>(7-bit))&1)===1; bit++; if(bit===8){bit=0;byte++;} }
            this.modules[rr][cc]=dark;
          }
        }
        row+=dir;
        if(row<0 || row>=n){ row = (row<0?0:n-1); dir*=-1; col-=2; break; }
      }
      if(col<=0) break;
    }
    return true;
  };

  function placeFinder(qr,r,c){
    for(let y=-1;y<=7;y++) for(let x=-1;x<=7;x++){
      const yy=r+y, xx=c+x; if(yy<0||yy>=qr.moduleCount||xx<0||xx>=qr.moduleCount) continue;
      qr.modules[yy][xx] = (y>=0&&y<=6&&(x===0||x===6||y===0||y===6)) || (y>=2&&y<=4&&x>=2&&x<=4);
    }
  }
  function placeTiming(qr){
    for(let i=8;i<qr.moduleCount-8;i++){ qr.modules[i][6]=(i%2===0); qr.modules[6][i]=(i%2===0); }
  }
  function placeAlignment(qr){
    const pos=[6,18,22,26,30]; // simplified positions for versions ≤10
    for(let i=0;i<pos.length;i++) for(let j=0;j<pos.length;j++){
      const r=pos[i], c=pos[j];
      if(r>=qr.moduleCount||c>=qr.moduleCount) continue;
      if((i===0&&j===0)||(i===0&&c===qr.moduleCount-7)||(r===qr.moduleCount-7&&j===0)) continue;
      for(let y=-2;y<=2;y++) for(let x=-2;x<=2;x++){
        const yy=r+y, xx=c+x; if(yy<0||yy>=qr.moduleCount||xx<0||xx>=qr.moduleCount) continue;
        qr.modules[yy][xx] = Math.max(Math.abs(x),Math.abs(y))!==1;
      }
    }
  }

  function svgFromQR(qr, cellSize=6, margin=2){
    const count=qr.moduleCount, size=(count+2*margin)*cellSize;
    let s=\`<svg xmlns="http://www.w3.org/2000/svg" width="\${size}" height="\${size}" viewBox="0 0 \${size} \${size}">\`;
    s+=\`<rect width="100%" height="100%" fill="white"/><g fill="black">\`;
    for(let r=0;r<count;r++) for(let c=0;c<count;c++){
      if(qr.modules[r][c]) s+=\`<rect x="\${(c+margin)*cellSize}" y="\${(r+margin)*cellSize}" width="\${cellSize}" height="\${cellSize}"/>\`;
    }
    s+='</g></svg>'; return s;
  }

  function makeWAQr(){
    try{
      const qr=new QR(0, EC.M);
      qr.addData(WA_URL);
      qr.make();
      const svg=svgFromQR(qr, 6, 2); // cellSize=6, margin=2
      waQR.innerHTML = svg;
    }catch(e){
      console.error(e);
      waQR.innerHTML = '<div style="color:#fca5a5;font-size:12px">QR failed to render</div>';
    }
  }
})();
</script>
</body>
</html>
